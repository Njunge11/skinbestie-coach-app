# PR Preview Workflow
# This workflow runs when a Pull Request is opened, updated, or reopened
# It applies schema changes to the shared staging database and runs tests

name: PR Preview - Setup and Test

on:
  pull_request:
    types: [opened, synchronize, reopened]  # opened = new PR, synchronize = new commits pushed, reopened = PR reopened
    branches:
      - main      # PRs targeting main branch
      - staging   # PRs targeting staging branch

# Allow manual trigger with seeding option
  workflow_dispatch:
    inputs:
      run_seeders:
        description: 'Run database seeders (creates test data)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

# Permissions needed for the workflow
permissions:
  contents: read          # Read repository contents
  issues: write           # Post comments on issues
  pull-requests: write    # Post comments on pull requests

jobs:
  setup-and-test:
    runs-on: ubuntu-latest
    # Skip this job if the PR is from the staging branch itself
    if: github.head_ref != 'staging'

    steps:
      # Step 1: Get the code from the feature branch
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Setup Node.js with npm caching to speed up subsequent runs
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'  # Caches node_modules for faster installs

      # Step 3: Install dependencies from package-lock.json (reproducible builds)
      - name: Install dependencies
        run: npm ci

      # Step 4: Apply database migrations to staging
      # Runs migration SQL files that were generated locally with db:generate
      # These migrations are version-controlled and reviewable before deployment
      # Note: Uses Session Pooler (port 5432) which supports prepared statements
      - name: Apply database migrations to staging
        run: npm run db:migrate
        env:
          DATABASE_URL: ${{ secrets.SUPABASE_DATABASE_URL }}

      # Step 5: Insert test data into the database (CONFIGURABLE)
      # Only runs if RUN_SEEDERS is set to 'true'
      # By default, seeders do NOT run to save time
      # To run seeders: Set RUN_SEEDERS=true in GitHub Actions secrets
      # Or manually trigger workflow with run_seeders=true
      - name: Seed database
        if: ${{ vars.RUN_SEEDERS == 'true' || inputs.run_seeders == 'true' }}
        run: |
          echo "üå± Running database seeders..."
          echo "Creating user profiles..."
          npx tsx src/scripts/seed-sample-users.ts
          echo "Seeding detailed profile data..."
          npx tsx src/scripts/seed-profiles.ts
          echo "‚úÖ Seeding complete!"
        env:
          DATABASE_URL: ${{ secrets.SUPABASE_DATABASE_URL }}

      # Step 5b: Skip seeding message (when seeders are disabled)
      - name: Seeders skipped
        if: ${{ vars.RUN_SEEDERS != 'true' && inputs.run_seeders != 'true' }}
        run: |
          echo "‚è≠Ô∏è  Database seeders skipped (RUN_SEEDERS not enabled)"
          echo "To enable seeders:"
          echo "  1. Go to Settings ‚Üí Secrets and variables ‚Üí Actions ‚Üí Variables"
          echo "  2. Add variable: RUN_SEEDERS = true"
          echo "  3. Or manually trigger workflow with run_seeders=true"

      # Step 6: Run all tests against staging database
      # Tests validate that your changes work correctly
      # If tests fail, the PR will be blocked from merging
      - name: Run tests
        run: npm run test:run
        env:
          DATABASE_URL: ${{ secrets.SUPABASE_DATABASE_URL }}

      # Step 7: Post success message on the PR
      # This provides visibility that tests passed
      - name: Comment PR - Tests Passed
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const seeded = '${{ vars.RUN_SEEDERS }}' === 'true' || '${{ inputs.run_seeders }}' === 'true';
            const seedingNote = seeded ? '\nüå± Test data seeded' : '\n‚è≠Ô∏è  Seeders skipped (enable RUN_SEEDERS variable to seed data)';
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚úÖ Schema applied to staging database\n\n‚úÖ Tests passed!' + seedingNote
            })
